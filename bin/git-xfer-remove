#!/bin/bash
#
# remove functionality of git-xfer plugin
# 
# @author <bprinty@gmail.com>
# ------------------------------------------------


# meta
# ----
usage() {
    echo "usage: git xfer remove [options] <file>"
    echo ""
    echo "Options:"
    echo "  -h | --help              Show help and exit."
}


# exec
# ----
remove(){
    if [ $delete ]; then
        rm "$1"
    fi
    fname=`xescape "$1"`
    grep -v "$fname" "$cache" > "$cache.lck"
    grep -v "$fname" "$exclude" > "$exclude.lck"
    mv "$cache.lck" "$cache"
    mv "$exclude.lck" "$exclude"
}

xrun() {
    if [ "$#" -lt 1 ]; then
        usage; exit 1
    fi

    case "$1" in
        "-h"|"--help")
            usage; exit 0
            ;;
        "-d"|"")
            delete="TRUE" && shift
            ;;
    esac

    for i in "$@"; do
        if [ "$i" = "." ]; then
            fullpath=`pwd`
        else
            fullpath=$(cd "$(dirname "$i")" && pwd -P)/$(basename "$i")
        fi
        if [ -d "$fullpath" ]; then
            if [ $delete ]; then
                find "$fullpath" -type f -exec git xfer rm {} \;
            else
                find "$fullpath" -type f -exec git xfer remove {} \;
            fi
        else
            remove "$fullpath"
        fi
    done
}
