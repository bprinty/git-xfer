#!/usr/bin/env sh
#
# push functionality of git-xfer plugin
# 
# @author <bprinty@gmail.com>
# ------------------------------------------------


# meta
# ----
usage() {
    echo "usage: git xfer push [options] <remote>"
    echo ""
    echo "Options:"
    echo "  -h | --help              Show help and exit."
}


# exec
# ----
main() {
    if [ "$#" -lt 1 ]; then
        usage; exit 1
    fi

    case "$1" in
        "-h"|"--help")
            usage; exit 0
            ;;
        "-p"|"--port")
            port="$2"; shift; shift
            ;;
    esac

    local dest="$1"

    # verify remote
    remote=`git remote -v | grep "$dest" | awk '{ print $2 }' | uniq | sed 's/\.git$//'`
    if [ ! "$remote" ]; then
        echo 'cannot find remote -- try git remote add <remote> <url>'
    fi

    # handle ssh url type
    if [ `echo "$remote" | grep 'ssh://'` ]; then
        urlstring=`echo "$remote" | sed 's|ssh://||' | sed 's|:|  |' | sed 's|/|  /|'`
        url=`echo "$urlstring" | awk '{ print $1 }'`
        if [ ! `echo "$urlstring" | awk '{ print $3 }'` ]; then
            port="22"
            repo=`echo "$urlstring" | awk '{ print $2 }'`
        else
            port=`echo "$urlstring" | awk '{ print $2 }'`
            repo=`echo "$urlstring" | awk '{ print $3 }'`
        fi

    # don't allow operations to github (they have git-lfs)
    elif [ `echo "$remote" | grep 'github.com'` ]; then
        echo 'Syncing with GitHub is not supported!'
        exit 1

    # ssh specification without port
    elif [ `echo "$remote" | grep '@' | grep ':'` ]; then
        url=`echo "$remote" | sed 's|:|  |' | awk '{ print $1 }'`
        port="22"
        repo=`echo "$remote" | sed 's|:|  |' | awk '{ print $2 }'`
    
    # local repo
    else
        repo="$remote"
    fi

    # update remote
    branch=`git branch | grep '* '| sed 's/\* //g'`
    if [ `echo $branch | grep 'detached from' | wc -l` -ne 0 ]; then
        echo 'git-xfer will not work on a detached branch!'
        exit 1
    fi
    git xfer sync "$dest" "$branch"

    # do the copying
    cd "$base"
    for file in `grep -v ",$dest" "$cache" | awk '{ print $2 }'`; do
		# copy locally
        if [ -z $port ]; then
            mkdir -p `dirname "$repo/$file"`
            if [ `which rsync` ]; then
                rsync -avz --progress "$file" "$repo/$file"
            else
                cp "$file" "$repo/$file"
            fi
            cd "$repo" && git xfer add "$file" && cd "$base"
        
        # copy over ssh
        else
            ssh -q -p $port -o StrictHostKeyChecking=no "$url" "cd $repo; mkdir -p `dirname $file`"
            if [ `which rsync` ]; then
                rsync -avz -e "ssh -q -p $port -o StrictHostKeyChecking=no" --progress "$file" "$url:$repo/$file"
            else
                scp -P $port "$file" "$url:$repo/$file"
            fi
            ssh -q -p $port -o StrictHostKeyChecking=no "$url" "cd $repo; git xfer add \"$file\"" 2>&1 1>/dev/null
        fi

        # update cache
		grep -v "$file  " "$cache" > "$cache.lck"
		echo `grep "$file  " "$cache" | sed "s|,$dest||"`,$dest >> "$cache.lck"
		mv "$cache.lck" "$cache"
    done

    exit 0

}

base=`git rev-parse --show-toplevel`
cache=$base/.git/xfer/cache
main "$@"
