#!/usr/bin/env sh
#
# push functionality of git-xfer plugin
# 
# @author <bprinty@gmail.com>
# ------------------------------------------------


# meta
# ----
usage() {
    echo "usage: git xfer diff [options] <remote>"
}


# exec
# ----
main() {
    if [ "$#" -eq 0 ]; then
        usage; exit 1
    fi

    case $1 in
        "-h"|"--help")
            usage; exit 0
            ;;
    esac

    local dest="$1"

    # verify remote
    remote=`git remote -v | grep "$dest" | awk '{ print $2 }' | uniq | sed 's/\.git$//'`
    if [ ! "$remote" ]; then
        echo 'cannot find remote -- try git remote add <remote> <url>'
        exit 1
    fi

    remotecache="$base/.git/xfer/cache-$dest"
    touch "$remotecache"
    touch "$cache"
    diff "$cache" "$remotecache" | tail -n+2

}

base=`git rev-parse --show-toplevel`
cache="$base/.git/xfer/cache"
main "$@"
