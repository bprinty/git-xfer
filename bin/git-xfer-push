#!/usr/bin/env sh
#
# push functionality of git-xfer plugin
# 
# @author <bprinty@gmail.com>
# ------------------------------------------------


# meta
# ----
usage() {
    echo "usage: git xfer push [options] <remote>"
    echo ""
    echo "Options:"
    echo "  -h | --help              Show help and exit."
    echo "  -p | --port              Explicitly set port for remote."
}


# exec
# ----
xrun() {

    if [ "$#" -lt 1 ]; then
        usage; exit 1
    fi

    case "$1" in
        "-h"|"--help")
            usage; exit 0
            ;;
        "-p"|"--port")
            port="$1": shift
            ;;
    esac
    
    # verify remote
    dest="$1"
    remote=`git remote -v | grep "$dest" | awk '{ print $2 }' | uniq | sed 's/\.git$//'`
    if [ ! "$remote" ]; then
        echo 'cannot find remote -- try git remote add <remote> <url>'
    fi

    # update remote
    if [ -z $port ]; then
        port=`xremoteport "$remote"`
    fi
    url=`xremoteurl "$remote"`
    repo=`xremoterepo "$remote"`
    branch=`git branch | grep '* '| sed 's/\* //g'`
    arbase=".git-xfer-archive-list.$$"
    rcache=`echo "$cache" | sed "s|$base|$repo|g"`
    cd "$base"
    "$scriptdir/git-xfer" diff "$dest" | grep '<' | sed 's|< ||g' > "$arbase.txt"
    "$scriptdir/git-xfer" archive "$arbase" "$arbase.txt"
    cat << EOF > "$arbase.sh"
#!/bin/bash
tar xvf "$arbase.tar.gz"
git xfer add -f "$arbase.txt"
rm -f "$arbase.tar.gz" "$arbase.txt" "$arbase.sh"
EOF
    >&2 echo "Transferring files..."
    if [ "$url" ]; then
        scp -P $port "$arbase.tar.gz" "$arbase.txt" "$arbase.sh" "$url":"$repo/" &>/dev/null
        ssh -p $port $url "cd $repo && sh $arbase.sh"
    else
        cp "$arbase.tar.gz" "$arbase.txt" "$arbase.sh" "$repo/"
        cd "$repo" && sh "$arbase.sh" && cd "$base"
    fi
    rm -f "$arbase.tar.gz" "$arbase.txt" "$arbase.sh"

    exit 0
}
