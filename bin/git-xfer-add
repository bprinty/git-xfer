#!/bin/bash
#
# push functionality of git-xfer plugin
# 
# @author <bprinty@gmail.com>
# ------------------------------------------------


# meta
# ----
usage() {
    echo "usage: git xfer add [options] <file>"
    echo ""
    echo "Options:"
    echo "  -h | --help              Show help and exit."
    echo "  -f | --list              Input argument is list of files."
}


# exec
# ----
add(){
    fname=`xescape "$1"`
    echo "$fname" >> "$cache"
    echo "$fname" >> "$exclude"
    sort "$cache" | uniq > "$cache.lck"
    mv "$cache.lck" "$cache"
    sort "$exclude" | uniq > "$exclude.lck"
    mv "$exclude.lck" "$exclude"
}

xrun() {
    if [ "$#" -lt 1 ]; then
        usage; exit 1
    fi

    case "$1" in
        "-h"|"--help")
            usage; exit 0
            ;;
        "-f"|"--list")
            LIST='TRUE'; shift
            ;;
    esac

    OLDIFS=$IFS;
    IFS="$(printf '\n\t')"
    if [ -z $LIST ]; then
        touch "$cache"
        for i in "$@"; do
            if [ "$i" = "." ]; then
                fullpath="`pwd`"
            else
                fullpath=$(cd "$(dirname $i)" && pwd -P)/$(basename "$i")
            fi
            if [ -d "$fullpath" ]; then
                find "$fullpath" -type f -exec "$scriptdir/git-xfer" add {} \;
            else
                add "$fullpath"
            fi
        done
    else
        for i in `cat "$1"`; do
            fullpath=$(cd "$(dirname $i)" && pwd -P)/$(basename "$i")
            add "$fullpath"
        done
    fi
    IFS=$OLDIFS
}
