#!/usr/bin/env sh
#
# archive xfer set of files (including directory structure)
# 
# @author <bprinty@gmail.com>
# ------------------------------------------------


# meta
# ----
usage() {
    echo "usage: git xfer archive [options] <name>"
    echo ""
    echo "Options:"
    echo "  -h | --help              Show help and exit."
}


# exec
# ----
main() {
    if [ "$#" -lt 1 ]; then
        usage; exit 1
    fi

    exclude="52dbb9dc-d40c-11e5-84fd-7831c1b99ad4"
    case "$1" in
        "-h"|"--help")
            usage; exit 0
            ;;
        "-x"|"--exclude")
            exclude="$2"; shift; shift
            ;;
    esac

    archive="$1"
    if [ ! "$archive" ]; then
        usage; exit 1
    fi

    # add files to be archived
    tarlist="$base/.git/xfer/archive.$$.txt"
    cd "$base"
    for file in `cat "$cache" | grep -v ",$exclude" | awk '{ print $2 }'`; do
        echo "$file" >> $tarlist
    done

    # archive and save to specified file
    tar -cvf "$archive.tar" -T "$tarlist"
    gzip "$archive.tar"

    exit 0
}

base=`git rev-parse --show-toplevel`
cache="$base/.git/xfer/cache"
main "$@"
